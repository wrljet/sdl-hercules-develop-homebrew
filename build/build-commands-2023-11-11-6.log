#!/usr/bin/env bash

if [[ $TRACE == true ]]; then
    set -x # For debugging, show all commands as they are being run
fi

# Created by Hercules-Helper version: 
# /Users/bill/hercules-helper/hercules-buildall.sh: v0.9.14-42-g9396540

# Darwin Bills-Mac.local 18.7.0 Darwin Kernel Version 18.7.0: Tue Jun 22 19:37:08 PDT 2021; root:xnu-4903.278.70~1/RELEASE_X86_64 x86_64

# C compiler: Apple clang version 11.0.0 (clang-1100.0.33.16)

# Environment variables used:
# PATH="/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/opt/X11/bin"
# SUDO_ASKPASS=""
# CC="cc"
# GCC=""
# CFLAGS=""
# CPPFLAGS=""
# LDFLAGS=""
# LD_LIBRARY_PATH=""

opt_build_dir="/Users/bill/sdl-hercules-develop-homebrew/build/hyperion"
opt_install_dir="/usr/local"
opt_regina_dir="Regina-REXX-3.6"
opt_regina_tarfile="Regina-REXX-3.6.tar.gz"
opt_regina_url="http://www.wrljet.com/ibm360/Regina-REXX-3.6.tar.gz"
git_repo_hercules="https://github.com/SDL-Hercules-390/hyperion.git"
git_branch_hercules=""
git_commit_hercules=""
git_repo_extpkgs="https://github.com/SDL-Hercules-390"
git_branch_extpkgs=""
opwd="/Users/bill/sdl-hercules-develop-homebrew/build"
HH_SUDOCMD="sudo"
sudo mkdir -p $opt_install_dir

# Install required packages: 
# brew install wget autoconf automake libtool cmake gsed
/Users/bill/hercules-helper/helper-check-packages.sh

# git clone required repos
cd $opt_build_dir
rm -rf hyperion
git clone $git_repo_hercules
cd $opt_build_dir
rm -rf extpkgs
mkdir extpkgs
cd extpkgs/
rm -rf *
git clone $git_repo_extpkgs/crypto
git clone $git_repo_extpkgs/decNumber
git clone $git_repo_extpkgs/SoftFloat
git clone $git_repo_extpkgs/telnet

# Prepare and build extpkgs

cd $opt_build_dir/extpkgs
rm -rf lib/
mkdir -p build/crypto64.Release
pushd build/crypto64.Release
rm -f CMakeCache.txt
cmake      -D INSTALL_PREFIX=/Users/bill/sdl-hercules-develop-homebrew/build/extpkgs     -DLIB_INSTALL_DIR=lib     /Users/bill/sdl-hercules-develop-homebrew/build/extpkgs/crypto
make clean
make -j 4 all
make install
mkdir -p build/decNumber64.Release
pushd build/decNumber64.Release
rm -f CMakeCache.txt
cmake      -D INSTALL_PREFIX=/Users/bill/sdl-hercules-develop-homebrew/build/extpkgs     -DLIB_INSTALL_DIR=lib     /Users/bill/sdl-hercules-develop-homebrew/build/extpkgs/decNumber
make clean
make -j 4 all
make install
mkdir -p build/SoftFloat64.Release
pushd build/SoftFloat64.Release
rm -f CMakeCache.txt
cmake      -D INSTALL_PREFIX=/Users/bill/sdl-hercules-develop-homebrew/build/extpkgs     -DLIB_INSTALL_DIR=lib     /Users/bill/sdl-hercules-develop-homebrew/build/extpkgs/SoftFloat
make clean
make -j 4 all
make install
mkdir -p build/telnet64.Release
pushd build/telnet64.Release
rm -f CMakeCache.txt
cmake      -D INSTALL_PREFIX=/Users/bill/sdl-hercules-develop-homebrew/build/extpkgs     -DLIB_INSTALL_DIR=lib     /Users/bill/sdl-hercules-develop-homebrew/build/extpkgs/telnet
make clean
make -j 4 all
make install

cd $opt_build_dir/hyperion
export CFLAGS="$CFLAGS -I$(find $(brew --cellar libtool) -type d -name "include" | sort -n | tail -n 1)"
export LDFLAGS="$LDFLAGS -L$(find $(brew --cellar libtool) -type d -name "lib" | sort -n | tail -n 1)"

# Do an out-of-source build
pushd $opt_build_dir/hyperion
mkdir -p build
cd build

# Configure and build Hercules
 ../configure \
     \
    --enable-optimization="-g -g3 -ggdb3 -O3 -march=native" \
    --enable-extpkgs=$opt_build_dir/extpkgs \
    --prefix=$opt_install_dir \
    --enable-custom="Built using Hercules-Helper (version: v0.9.14-42-g9396540)" \
    --enable-regina-rexx \
     \
     \
    --disable-getoptwrapper \
    --without-included-ltdl

./config.status --config
popd >/dev/null;
cd build
make clean
time make -j 3 2>&1
time make check
$HH_SUDOCMD time make install 2>&1
cd $opwd
